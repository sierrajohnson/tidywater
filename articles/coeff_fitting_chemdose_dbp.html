<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting and using custom coefficients in chemdose_dbp • tidywater</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting and using custom coefficients in chemdose_dbp">
<meta name="description" content="This vignette will detail how to use custom coefficients to predict DBP formation.">
<meta property="og:description" content="This vignette will detail how to use custom coefficients to predict DBP formation.">
<meta property="og:image" content="https://BrownandCaldwell-Public.github.io/tidywater/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidywater</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.10.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tidywater.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/coeff_fitting_chemdose_dbp.html">Fitting and using custom coefficients in chemdose_dbp</a></li>
    <li><a class="dropdown-item" href="../articles/help_functions_blend_waters.html">Blending Multiple Waters</a></li>
    <li><a class="dropdown-item" href="../articles/help_functions_chemdose_ph.html">Helper Functions &amp; Dose Chemicals</a></li>
    <li><a class="dropdown-item" href="../articles/intro.html">Introduction to tidywater: Basic functions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BrownandCaldwell-Public/tidywater/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting and using custom coefficients in chemdose_dbp</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BrownandCaldwell-Public/tidywater/blob/main/vignettes/coeff_fitting_chemdose_dbp.Rmd" class="external-link"><code>vignettes/coeff_fitting_chemdose_dbp.Rmd</code></a></small>
      <div class="d-none name"><code>coeff_fitting_chemdose_dbp.Rmd</code></div>
    </div>

    
    
<p>This vignette assumes a basic understanding of
<code>define_water</code> and the S4 <code>water</code> class. See
<code><a href="../articles/intro.html">vignette("intro", package = "tidywater")</a></code> for more
information. Additionally, for more information on tidywater’s
<code>_df</code> and <code>pluck_waters</code> functions, please see the
<code><a href="../articles/help_functions_chemdose_ph.html">vignette("help_functions_chemdose_ph", package = "tidywater")</a></code>.</p>
<div class="section level2">
<h2 id="water-setup">Water setup<a class="anchor" aria-label="anchor" href="#water-setup"></a>
</h2>
<p>Let’s assume we’re working with a drinking water treatment facility
that is concerned about disinfection byproducts (DBPs) in its
distribution system and want to use tidywater to help predict DBP
formation due to chlorine addition. In an initial assessment, we can use
the facility’s influent water and disinfection method to predict DBPs
using the <code>chemdose_dbp</code> function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">influent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_water.html">define_water</a></span><span class="op">(</span>ph <span class="op">=</span> <span class="fl">7.5</span>, temp <span class="op">=</span> <span class="fl">20</span>, alk <span class="op">=</span> <span class="fl">50</span>, toc <span class="op">=</span> <span class="fl">4</span>, uv254 <span class="op">=</span> <span class="fl">.2</span>, br <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/chemdose_dbp.html">chemdose_dbp</a></span><span class="op">(</span>cl2 <span class="op">=</span> <span class="fl">2</span>, time <span class="op">=</span> <span class="fl">8</span>, treatment <span class="op">=</span> <span class="st">"coag"</span>, cl_type <span class="op">=</span> <span class="st">"chlorine"</span>, location <span class="op">=</span> <span class="st">"plant"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in define_water(ph = 7.5, temp = 20, alk = 50, toc = 4, uv254 = 0.2, :</span></span>
<span><span class="co">#&gt; Missing value for DOC. Default value of 95% of TOC will be used.</span></span>
<span><span class="co">#&gt; Warning in define_water(ph = 7.5, temp = 20, alk = 50, toc = 4, uv254 = 0.2, :</span></span>
<span><span class="co">#&gt; Major ions missing and neither TDS or conductivity entered. Ideal conditions</span></span>
<span><span class="co">#&gt; will be assumed. Ionic strength will be set to NA and activity coefficients in</span></span>
<span><span class="co">#&gt; future calculations will be set to 1.</span></span></code></pre></div>
<p>The influent water object now has populated slots corresponding to
predicted DBP concentrations after coagulation, including tthm for total
trihalomethanes and haa5 for sum of haloacetic acids. However, when
comparing these results to the facility’s record, we realize that the
default model coefficients used in <code>chemdose_dbp</code> don’t
accurately predict DBP formation at this facility. We can still use
<code>chemdose_dbp</code>; we just need to fit coefficients customized
for this facility.</p>
</div>
<div class="section level2">
<h2 id="fitting-dbp-coefficients">Fitting DBP coefficients<a class="anchor" aria-label="anchor" href="#fitting-dbp-coefficients"></a>
</h2>
<p>We can use the <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> function to fit custom
coefficients to the facility’s DBP data. In this example, let’s say that
only the predictions for chloroform (chcl3) are not accurate. First,
let’s visualize the facility data against the default DBP predictions.
As the graph shows, the default coefficients consistently under-predict
the amount of DBPs formed in the water (the points are below the 1:1
line).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Given sample data</span></span>
<span><span class="va">dbp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  ph <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7.04</span>, <span class="fl">7.5</span>, <span class="fl">7.9</span>, <span class="fl">7.2</span>, <span class="fl">7.25</span><span class="op">)</span>,</span>
<span>  temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  alk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">66</span>, <span class="fl">75</span>, <span class="fl">80</span>, <span class="fl">55</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  toc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">4</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  uv254 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  br <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  fin_chcl3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">62</span>, <span class="fl">138.5</span>, <span class="fl">71</span>, <span class="fl">206</span>, <span class="fl">83.5</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_water_df.html">define_water_df</a></span><span class="op">(</span><span class="st">"input"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predicted chcl3 concentrations using default coefficients</span></span>
<span><span class="va">plot_unfit_dbps</span> <span class="op">&lt;-</span> <span class="va">dbp_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/chemdose_dbp.html">chemdose_dbp_df</a></span><span class="op">(</span><span class="st">"input"</span>, cl2 <span class="op">=</span> <span class="fl">2</span>, time <span class="op">=</span> <span class="fl">8</span>, treatment <span class="op">=</span> <span class="st">"raw"</span>, cl_type <span class="op">=</span> <span class="st">"chlorine"</span>, location <span class="op">=</span> <span class="st">"plant"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pluck_water.html">pluck_water</a></span><span class="op">(</span>input_waters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"disinfected"</span><span class="op">)</span>, parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"chcl3"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_unfit_dbps</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fin_chcl3</span>, y <span class="op">=</span> <span class="va">disinfected_chcl3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Observed vs predicted chloroform"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Observed chloroform"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Default Predicted chloroform"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">expand_limits</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="coeff_fitting_chemdose_dbp_files/figure-html/initial-plot-1.png" class="r-plt" width="700"></p>
<p>Now, we can fit custom coefficients to the facility’s DBP data. The
following code builds off the code we’ve already used above and uses the
default chcl3 coefficients as the initial parameters. Even if
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> doesn’t converge, the new coefficients it outputs
should still provide a better fit than the defaults. Running
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> on this example should take approximately 2
seconds, which is typical for an <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> function. If
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> is not constrained by a number of maximum
iterations, it can take longer and parallel processing can be used to
speed it up if the time is too long.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model we're trying to fit</span></span>
<span><span class="va">model_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">custom_coeff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    ID <span class="op">=</span> <span class="st">"chcl3"</span>, <span class="st">"A"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"a"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="st">"d"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="st">"e"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>    <span class="st">"f"</span> <span class="op">=</span> <span class="va">params</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, ph_const <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/chemdose_dbp.html">chemdose_dbp_df</a></span><span class="op">(</span><span class="st">"input"</span>,</span>
<span>      cl2 <span class="op">=</span> <span class="fl">2</span>, time <span class="op">=</span> <span class="fl">8</span>, treatment <span class="op">=</span> <span class="st">"raw"</span>, cl_type <span class="op">=</span> <span class="st">"chlorine"</span>, location <span class="op">=</span> <span class="st">"plant"</span>,</span>
<span>      coeff <span class="op">=</span> <span class="va">custom_coeff</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/pluck_water.html">pluck_water</a></span><span class="op">(</span>input_waters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"disinfected"</span><span class="op">)</span>, parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"chcl3"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="op">(</span><span class="va">disinfected_chcl3</span> <span class="op">-</span> <span class="va">fin_chcl3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">temp_data</span><span class="op">$</span><span class="va">diff</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># optimize the coefficients</span></span>
<span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.237e-2</span>, <span class="fl">1.617</span>, <span class="op">-</span><span class="fl">0.094</span>, <span class="op">-</span><span class="fl">0.175</span>, <span class="fl">0.607</span>, <span class="fl">1.403</span>, <span class="fl">0.306</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">model_fn</span>, data <span class="op">=</span> <span class="va">dbp_data</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">coeffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  ID <span class="op">=</span> <span class="st">"chcl3"</span>,</span>
<span>  A <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  a <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>  b <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>  c <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>  d <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>  e <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>  f <span class="op">=</span> <span class="va">test</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>,</span>
<span>  ph_const <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dbp_data</span> <span class="op">&lt;-</span> <span class="va">dbp_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/chemdose_dbp.html">chemdose_dbp_df</a></span><span class="op">(</span>input_water <span class="op">=</span> <span class="st">"input"</span>, output_water <span class="op">=</span> <span class="st">"coeff_disinfected"</span>, cl2 <span class="op">=</span> <span class="fl">2</span>, time <span class="op">=</span> <span class="fl">8</span>, coeff <span class="op">=</span> <span class="va">coeffs</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pluck_water.html">pluck_water</a></span><span class="op">(</span>input_waters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"coeff_disinfected"</span><span class="op">)</span>, parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"chcl3"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_unfit_dbps</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fin_chcl3</span>, y <span class="op">=</span> <span class="va">disinfected_chcl3</span>, color <span class="op">=</span> <span class="st">"Default coeffs"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dbp_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fin_chcl3</span>, y <span class="op">=</span> <span class="va">coeff_disinfected_chcl3</span>, color <span class="op">=</span> <span class="st">"Custom coeffs"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Observed vs predicted chloroform"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Observed chloroform"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Predicted chloroform"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Prediction type"</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Default coeffs"</span>, <span class="st">"Custom coeffs"</span><span class="op">)</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">expand_limits</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="coeff_fitting_chemdose_dbp_files/figure-html/chloroform-plot-1.png" class="r-plt" width="700"></p>
<p>Note that when inputting the new coefficients into
<code>chemdose_dbp</code>, they must be formatted as a data frame with
the proper column names: ID (corresponding to which DBP these
coefficients apply to - for individual species, this will be its
chemical formula), A, a, b, c, d, e, and f. This data frame can then be
passed as an argument into <code>chemdose_dbp</code> and its helper
function. For this example, we can visualize the facility DBP data,
default DBP predictions, and custom DBP coefficient predictions to see
that the predictions from <code>chemdose_dbp</code> with custom
coefficients fits the real data a little better because it’s closer to
the 1:1 line. This coefficient optimization process can be repeated for
any DBPs whose concentrations do not fit the default coefficients well.
Now that the facility has custom coefficients for chloroform, they can
continue to use <code>chemdose_dbp</code> with coefficients that are
personalized to the plant and make better predictions for their effluent
chloroform.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>In this tutorial, we learned how to use custom coefficients to
predict DBP concentrations using the <code>coeff</code> argument in
<code>chemdose_dbp</code>. These custom coefficients can be obtained by
fitting using <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> and saved as a new data frame
containing the personalized values. The <code>coeff</code> argument
gives the user flexibility to create a model that best reflects their
specific conditions while still using the tidywater package.</p>
<p>For an introduction to the tidywater package, check out the intro and
tidywater vignettes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sierra Johnson, Libby McKenna, Riley Mulhern, Chris Corwin, Brown and Caldwell.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
